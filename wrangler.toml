name = "todoist-mcp-server"
main = "src/index.ts"

compatibility_date = "2024-11-05"
compatibility_flags = ["nodejs_compat"]

# Enable workers.dev subdomain for development
workers_dev = true

# D1 Database binding for token storage
[[d1_databases]]
binding = "DB"
database_name = "todoist-mcp-db"
database_id = "04870dd1-25c7-42f5-ab30-5f97b920ced2"

[[durable_objects.bindings]]
name = "MCP_OBJECT"
class_name = "TodoistMCPv3"

# Keep old class bindings alive for cleanup
[[durable_objects.bindings]]
name = "CLEANUP_V1"
class_name = "TodoistMCP"

[[durable_objects.bindings]]
name = "CLEANUP_V2"
class_name = "TodoistMCPv2"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["TodoistMCP"]

# v2: New class to reset DO namespace (old class storage will be orphaned but not accessed)
[[migrations]]
tag = "v2"
new_sqlite_classes = ["TodoistMCPv2"]

# v3: Previously deleted TodoistMCP (applied to production Jan 21)
[[migrations]]
tag = "v3"
deleted_classes = ["TodoistMCP"]

# v4: Create v3 class
[[migrations]]
tag = "v4"
new_sqlite_classes = ["TodoistMCPv3"]

# v5: Re-add TodoistMCP so we can access old DOs for cleanup
[[migrations]]
tag = "v5"
new_sqlite_classes = ["TodoistMCP"]

# Preview environment configuration
[env.preview]
name = "todoist-mcp-server-preview"

# Use same D1 database for now (you can create a separate one via Cloudflare Dashboard)
[[env.preview.d1_databases]]
binding = "DB"
database_name = "todoist-mcp-db"
database_id = "04870dd1-25c7-42f5-ab30-5f97b920ced2"

# Use separate Durable Object namespace for preview
[[env.preview.durable_objects.bindings]]
name = "MCP_OBJECT"
class_name = "TodoistMCPv3"

[[env.preview.durable_objects.bindings]]
name = "CLEANUP_V1"
class_name = "TodoistMCP"

[[env.preview.durable_objects.bindings]]
name = "CLEANUP_V2"
class_name = "TodoistMCPv2"

# [[routes]]
# pattern = "todoist.mcp.rosenpin.io/*"
# zone_name = "rosenpin.io"
